<script>
    // --- 1. SMART DICTIONARY (API) ---
    async function fetchMeaning() {
        const word = document.getElementById('dict-input').value.trim();
        const output = document.getElementById('dict-output');
        const list = document.getElementById('meanings-list');
        
        if(!word) return;

        // Reset UI
        output.style.display = "block";
        list.innerHTML = "<p style='color:#666;'>Searching...</p>";
        document.getElementById('word-title').innerText = word;
        document.getElementById('word-phonetic').innerText = "";

        try {
            const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
            const data = await response.json();

            if(data.title || !data[0]) {
                list.innerHTML = "<p style='color:red;'>Word not found. Try a basic word.</p>";
                return;
            }

            const entry = data[0];
            document.getElementById('word-title').innerText = entry.word;
            document.getElementById('word-phonetic').innerText = entry.phonetic || "";
            
            // Audio logic
            let audioObj = entry.phonetics.find(p => p.audio && p.audio.length > 0);
            window.currentAudio = audioObj ? audioObj.audio : null;

            // Meanings logic
            let meaningsHTML = "";
            entry.meanings.forEach(m => {
                // Limit to 2 definitions per part of speech to keep it clean
                let def = m.definitions[0].definition;
                meaningsHTML += `<div style="margin-bottom:8px;">
                    <span style="background:#e0f2fe; color:#0284c7; padding:2px 6px; border-radius:4px; font-size:0.75rem; font-weight:bold; text-transform:uppercase;">${m.partOfSpeech}</span> 
                    <span style="color:#334155;">${def}</span>
                </div>`;
            });
            list.innerHTML = meaningsHTML;

        } catch (error) {
            list.innerHTML = "<p style='color:red;'>Internet error.</p>";
        }
    }

    function playAudio() {
        if(window.currentAudio) {
            new Audio(window.currentAudio).play();
        } else {
            alert("Audio not available for this word.");
        }
    }

    // --- 2. ADVANCED VOICE CONVERTER (Active -> Passive) ---
    
    // Database of Irregular Verbs (V1 -> V3)
    const verbList = {
        "write": "written", "writes": "written", "wrote": "written",
        "speak": "spoken", "speaks": "spoken", "spoke": "spoken",
        "eat": "eaten", "eats": "eaten", "ate": "eaten",
        "break": "broken", "breaks": "broken", "broke": "broken",
        "take": "taken", "takes": "taken", "took": "taken",
        "drive": "driven", "drives": "driven", "drove": "driven",
        "know": "known", "knows": "known", "knew": "known",
        "see": "seen", "sees": "seen", "saw": "seen",
        "play": "played", "plays": "played", "played": "played",
        "love": "loved", "loves": "loved", "loved": "loved",
        "watch": "watched", "watches": "watched", "watched": "watched",
        "help": "helped", "helps": "helped", "helped": "helped",
        "cook": "cooked", "cooks": "cooked", "cooked": "cooked"
    };

    // Pronoun Swap Map
    const pronouns = {
        "i": "me", "he": "him", "she": "her", "we": "us", "they": "them"
    };

    function convertVoice() {
        let input = document.getElementById('active-input').value.trim();
        // Remove punctuation
        input = input.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
        
        let words = input.split(" ");
        let result = "";
        
        // Error handling for short sentences
        if (words.length < 3) {
            document.getElementById('passive-result').innerText = "Sentence too short. Format: Subject + Verb + Object";
            document.getElementById('voice-output').style.display = "block";
            return;
        }

        // 1. Identify Components
        let subject = words[0];
        let object = words.slice(2).join(" "); // Handles "a letter" or "the ball"
        let verb = words[1].toLowerCase();
        let tense = "present";
        let isContinuous = false;

        // 2. Continuous Tense Detection (is playing)
        if (verb === "is" || verb === "am" || verb === "are") {
            isContinuous = true;
            verb = words[2]; // The main verb is the 3rd word (playing)
            object = words.slice(3).join(" "); // Object shifts
            
            // Remove 'ing' from verb (playing -> play)
            if(verb.endsWith("ing")) verb = verb.slice(0, -3);
        }

        // 3. Past Tense Detection
        // If verb is in past list OR ends in 'ed' and not 'is/am/are'
        const pastVerbs = ["ate", "wrote", "spoke", "took", "saw", "cooked", "played", "loved"];
        if (pastVerbs.includes(verb) || (verb.endsWith("ed") && !isContinuous)) {
            tense = "past";
        }

        // 4. Get V3 Form (Past Participle)
        let v3 = verbList[verb] || (verb.endsWith("e") ? verb + "d" : verb + "ed");

        // 5. Choose Helper Verb (Is/Are/Was/Were) based on OBJECT
        let helper = "";
        let isPlural = object.endsWith("s"); // Crude plural detection (apples)

        if (tense === "present") {
            helper = isPlural ? "are" : "is";
        } else {
            helper = isPlural ? "were" : "was";
        }

        // 6. Handle Pronoun Swap (Subject)
        let subjectLower = subject.toLowerCase();
        let newSubject = pronouns[subjectLower] ? pronouns[subjectLower] : subject;

        // 7. Construct Sentence
        if (isContinuous) {
            // Passive Continuous: Object + is/are + BEING + V3 + by + Subject
            result = `${object} ${helper} being ${v3} by ${newSubject}`;
        } else {
            // Passive Simple: Object + is/are/was/were + V3 + by + Subject
            result = `${object} ${helper} ${v3} by ${newSubject}`;
        }

        // Capitalize first letter
        result = result.charAt(0).toUpperCase() + result.slice(1);

        document.getElementById('passive-result').innerText = result;
        document.getElementById('voice-output').style.display = "block";
    }

    // --- 3. SPEECH CONVERTER ---
    function convertSpeech() {
        let input = document.getElementById('direct-input').value.trim();
        let result = "";
        let rule = "";

        // Normalize quotes
        input = input.replace(/“/g, '"').replace(/”/g, '"');

        if (input.toLowerCase().includes("says")) {
            // Present Tense Reporting
            let parts = input.split(",");
            let speaker = parts[0]; 
            let dialogue = parts[1].replace(/"/g, "").trim();
            
            // Simple Pronoun swap
            dialogue = dialogue.replace(/\bI\b/g, "he/she").replace(/\bmy\b/g, "his/her");
            
            result = `${speaker} that ${dialogue}`;
            rule = "Reporting verb is 'says' (Present), so tense does NOT change.";
        } 
        else if (input.toLowerCase().includes("said")) {
            // Past Tense Reporting
            let parts = input.split(",");
            let speaker = parts[0]; 
            let dialogue = parts[1].replace(/"/g, "").trim();

            // Tense Backshift Rules
            dialogue = dialogue.replace(/\bam\b/g, "was");
            dialogue = dialogue.replace(/\bis\b/g, "was");
            dialogue = dialogue.replace(/\bare\b/g, "were");
            dialogue = dialogue.replace(/\bhave\b/g, "had");
            dialogue = dialogue.replace(/\bwill\b/g, "would");
            dialogue = dialogue.replace(/\bcan\b/g, "could");
            dialogue = dialogue.replace(/\bplay\b/g, "played");
            
            // Pronouns
            dialogue = dialogue.replace(/\bI\b/g, "he/she").replace(/\bmy\b/g, "his/her");

            result = `${speaker} that ${dialogue}`;
            rule = "Reporting verb is 'said' (Past), so Present changes to Past.";
        } 
        else {
            result = "Please check format. Example: He said, \"I am happy\"";
            rule = "Could not detect 'said' or 'says'.";
        }

        document.getElementById('indirect-result').innerText = result;
        document.getElementById('speech-rule').innerText = rule;
        document.getElementById('speech-output').style.display = "block";
    }

    // --- 4. UTILS ---
    function generateLetter() {
        // Same logic as before
        let s = document.getElementById('l-subject').value;
        let r = document.getElementById('l-reason').value;
        let t = `To,\nThe Principal\n\nSubject: ${s}\n\nSir,\nMost respectfully, ${r}\n\nYours Obediently,\nXYZ`;
        document.getElementById('letter-output').innerText = t;
        document.getElementById('letter-output').style.display = 'block';
    }
</script>
